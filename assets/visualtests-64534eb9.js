import{g as B,r as b,j as x,c as F}from"./index-97f852db.js";import{m as M,l as N,a as Y}from"./maplibre-gl-3238adf5.js";const V=[{name:"taiwan-z8",description:"Compare the appearance of highways",tags:["highway","cjk"],center:[121.333,24.32],zoom:8},{name:"taiwan-z16-buildings",description:"Compare the appearance of buildings",tags:["buildings","cjk"],center:[121.4818,25.0271],zoom:16},{name:"world",description:"Country labels",tags:[],center:[121,25],zoom:4},{name:"world2",description:"Country labels",tags:[],center:[0,0],zoom:2}];var X=Q;const G={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function Q(e,t,n,a,l,s){if(!E(e)||!E(t)||n&&!E(n))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(e.length!==t.length||n&&n.length!==e.length)throw new Error("Image sizes do not match.");if(e.length!==a*l*4)throw new Error("Image data size does not match width/height.");s=Object.assign({},G,s);const f=a*l,d=new Uint32Array(e.buffer,e.byteOffset,f),i=new Uint32Array(t.buffer,t.byteOffset,f);let c=!0;for(let r=0;r<f;r++)if(d[r]!==i[r]){c=!1;break}if(c){if(n&&!s.diffMask)for(let r=0;r<f;r++)S(e,4*r,s.alpha,n);return 0}const m=35215*s.threshold*s.threshold;let o=0;for(let r=0;r<l;r++)for(let u=0;u<a;u++){const h=(r*a+u)*4,p=O(e,t,h,h);Math.abs(p)>m?!s.includeAA&&(I(e,u,r,a,l,t)||I(t,u,r,a,l,e))?n&&!s.diffMask&&z(n,h,...s.aaColor):(n&&z(n,h,...p<0&&s.diffColorAlt||s.diffColor),o++):n&&(s.diffMask||S(e,h,s.alpha,n))}return o}function E(e){return ArrayBuffer.isView(e)&&e.constructor.BYTES_PER_ELEMENT===1}function I(e,t,n,a,l,s){const f=Math.max(t-1,0),d=Math.max(n-1,0),i=Math.min(t+1,a-1),c=Math.min(n+1,l-1),m=(n*a+t)*4;let o=t===f||t===i||n===d||n===c?1:0,r=0,u=0,h,p,v,R;for(let C=f;C<=i;C++)for(let w=d;w<=c;w++){if(C===t&&w===n)continue;const j=O(e,e,m,(w*a+C)*4,!0);if(j===0){if(o++,o>2)return!1}else j<r?(r=j,h=C,p=w):j>u&&(u=j,v=C,R=w)}return r===0||u===0?!1:D(e,h,p,a,l)&&D(s,h,p,a,l)||D(e,v,R,a,l)&&D(s,v,R,a,l)}function D(e,t,n,a,l){const s=Math.max(t-1,0),f=Math.max(n-1,0),d=Math.min(t+1,a-1),i=Math.min(n+1,l-1),c=(n*a+t)*4;let m=t===s||t===d||n===f||n===i?1:0;for(let o=s;o<=d;o++)for(let r=f;r<=i;r++){if(o===t&&r===n)continue;const u=(r*a+o)*4;if(e[c]===e[u]&&e[c+1]===e[u+1]&&e[c+2]===e[u+2]&&e[c+3]===e[u+3]&&m++,m>2)return!0}return!1}function O(e,t,n,a,l){let s=e[n+0],f=e[n+1],d=e[n+2],i=e[n+3],c=t[a+0],m=t[a+1],o=t[a+2],r=t[a+3];if(i===r&&s===c&&f===m&&d===o)return 0;i<255&&(i/=255,s=y(s,i),f=y(f,i),d=y(d,i)),r<255&&(r/=255,c=y(c,r),m=y(m,r),o=y(o,r));const u=P(s,f,d),h=P(c,m,o),p=u-h;if(l)return p;const v=T(s,f,d)-T(c,m,o),R=L(s,f,d)-L(c,m,o),C=.5053*p*p+.299*v*v+.1957*R*R;return u>h?-C:C}function P(e,t,n){return e*.29889531+t*.58662247+n*.11448223}function T(e,t,n){return e*.59597799-t*.2741761-n*.32180189}function L(e,t,n){return e*.21147017-t*.52261711+n*.31114694}function y(e,t){return 255+(e-255)*t}function z(e,t,n,a,l){e[t+0]=n,e[t+1]=a,e[t+2]=l,e[t+3]=255}function S(e,t,n,a){const l=e[t+0],s=e[t+1],f=e[t+2],d=y(P(l,s,f),n*e[t+3]/255);z(a,t,d,d,d)}const $=B(X),U=(e,t)=>{const n=new Image,a=new Promise(l=>{n.onload=function(){e.drawImage(n,0,0),l()}});return n.src=t,a},k=(e,t,n)=>new Promise(a=>{e.on("idle",()=>{const l=e.getCanvas();a(l.toDataURL())}),e.jumpTo({center:t,zoom:n})}),q=(e,t,n,a)=>new M.Map({container:e,interactive:!1,style:{version:8,center:n,zoom:a,glyphs:"https://cdn.protomaps.com/fonts/pbf/{fontstack}/{range}.pbf",sources:{protomaps:{type:"vector",url:"pmtiles://"+t,attribution:""}},layers:N("protomaps","light")}}),A=new URLSearchParams(location.search),g=500*window.devicePixelRatio,H=async(e,t)=>{const[n,a]=await Promise.all([k(e.leftMap,t.center,t.zoom),k(e.rightMap,t.center,t.zoom)]);await U(e.leftCtx,n),await U(e.rightCtx,a);const l=e.diffCtx.createImageData(g,g),s=$(e.leftCtx.getImageData(0,0,g,g).data,e.rightCtx.getImageData(0,0,g,g).data,l.data,g,g,{threshold:.1});return e.diffCtx.putImageData(l,0,0),{pixelsDifferent:s,leftData:n,rightData:a,diffData:e.diffCanvas.toDataURL()}},_=e=>{const t=new URLSearchParams(A);return t.delete("name"),t.delete("tag"),e.name&&t.set("name",e.name),e.tag&&t.set("tag",e.tag),"/visualtests/?"+t.toString()};function J(e){const t=b.useRef(null),n=b.useRef(null),a=b.useRef(null);b.useEffect(()=>{t.current.src=e.result.rendered.leftData,n.current.src=e.result.rendered.rightData,a.current.src=e.result.rendered.diffData},[]);const l=e.result.example;return x.jsxs("div",{children:[x.jsxs("div",{children:[x.jsx("img",{ref:t}),x.jsx("img",{ref:n}),x.jsx("img",{ref:a})]}),x.jsx("a",{href:_({name:l.name}),children:l.name}),x.jsx("span",{children:l.description}),l.tags.map(s=>x.jsx("a",{href:_({tag:s}),children:s},s))]})}function K(){const e=b.useRef(null),t=b.useRef(null),n=b.useRef(null),a=b.useRef(null),l=b.useRef(null),[s,f]=b.useState([]),d=async(i,c)=>{for(const m of c){const o=await H(i,m);f(r=>[...r,{example:m,rendered:o}])}};return b.useEffect(()=>{M.getRTLTextPluginStatus()==="unavailable"&&M.setRTLTextPlugin("https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js",()=>{},!1);const i=new Y;M.addProtocol("pmtiles",i.tile);const c=A.get("name"),m=A.get("tag");let o=V;c!==null?o=o.filter(w=>w.name===c):m!==null&&(o=o.filter(w=>w.tags.indexOf(m)>=0));const r=o[0],u=q(e.current,"https://build.protomaps.com/20230915.pmtiles",r.center,r.zoom),h=q(t.current,"https://build.protomaps.com/20230915.pmtiles",r.center,r.zoom),p=n.current;p.width=g,p.height=g;const v=a.current;v.width=g,v.height=g;const R=l.current;R.width=g,R.height=g;const C={leftMap:u,rightMap:h,leftCtx:p.getContext("2d",{willReadFrequently:!0}),rightCtx:v.getContext("2d",{willReadFrequently:!0}),diffCtx:R.getContext("2d",{willReadFrequently:!0}),diffCanvas:R};return d(C,o),()=>{M.removeProtocol("pmtiles"),u.remove(),h.remove()}},[]),x.jsxs("div",{className:"visual-tests",children:[x.jsxs("div",{style:{position:"absolute",opacity:0,zIndex:-1},children:[x.jsx("div",{ref:e,className:"map"}),x.jsx("div",{ref:t,className:"map"}),x.jsx("canvas",{ref:n}),x.jsx("canvas",{ref:a}),x.jsx("canvas",{ref:l})]}),s.map(i=>x.jsx(J,{result:i},i.example.name))]})}F.createRoot(document.getElementById("root")).render(x.jsx(K,{}));
